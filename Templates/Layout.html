<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANIMES</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" 
    crossorigin="anonymous">
</head>
<body class="bg-light">
    {% include 'Partials/_navegationbar.html' %}

    <div class="mt-4">   
        {% block body %}
        {% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" 
            crossorigin="anonymous"></script>

    <!-- Script para cerrar sesi√≥n autom√°ticamente al cerrar la p√°gina -->
    <script>
        // === CIERRE DE SESI√ìN AUTOM√ÅTICO AL CERRAR P√ÅGINA ===
        let sessionActive = true;
        
        // Detectar cuando el usuario cierra la p√°gina/pesta√±a
        window.addEventListener('beforeunload', function(event) {
            if (sessionActive) {
                console.log('üö™ Detectado cierre de p√°gina - Cerrando sesi√≥n autom√°ticamente');
                
                // Usar sendBeacon para env√≠o confiable al cerrar p√°gina
                // sendBeacon es m√°s confiable que fetch() cuando la p√°gina se cierra
                const logoutData = new FormData();
                logoutData.append('auto_logout', 'true');
                
                try {
                    // Intentar con sendBeacon (m√°s confiable)
                    const beaconSent = navigator.sendBeacon('/users/auto-logout', logoutData);
                    
                    if (!beaconSent) {
                        // Fallback con fetch s√≠ncrono si sendBeacon falla
                        fetch('/users/auto-logout', {
                            method: 'POST',
                            body: logoutData,
                            keepalive: true  // Mantener petici√≥n viva al cerrar p√°gina
                        }).catch(error => {
                            console.warn('Error en auto-logout:', error);
                        });
                    }
                    
                    console.log('‚úÖ Solicitud de cierre de sesi√≥n enviada');
                } catch (error) {
                    console.error('‚ùå Error al enviar auto-logout:', error);
                }
                
                // Limpiar localStorage por seguridad adicional
                try {
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('jwtTokenUserId');
                    localStorage.removeItem('jwtRefreshToken');
                    localStorage.removeItem('jwtTokenExpirationTime');
                    localStorage.removeItem('jwtExpiresIn');
                    localStorage.removeItem('jwtTokenCreatedAt');
                    sessionStorage.clear();
                    console.log('üßπ localStorage limpiado por seguridad');
                } catch (e) {
                    console.warn('Error limpiando localStorage:', e);
                }
            }
        });
        
        // Detectar navegaci√≥n interna (no cerrar sesi√≥n en estos casos)
        window.addEventListener('pagehide', function(event) {
            // pagehide se ejecuta cuando la p√°gina se oculta (incluye navegaci√≥n)
            // Solo cerrar sesi√≥n si realmente se est√° cerrando la p√°gina
            if (event.persisted) {
                console.log('üìÑ P√°gina ocultada pero persistida - No cerrar sesi√≥n');
                sessionActive = false;  // Evitar cierre de sesi√≥n en navegaci√≥n interna
            }
        });
        
        // Desactivar auto-logout en logout manual
        const logoutLinks = document.querySelectorAll('a[href*="logout"]');
        logoutLinks.forEach(link => {
            link.addEventListener('click', function() {
                console.log('üö™ Logout manual detectado - Desactivando auto-logout');
                sessionActive = false;
            });
        });
        
        // Manejar m√∫ltiples pesta√±as - usar localStorage para coordinar
        try {
            // Generar ID √∫nico para esta pesta√±a
            const tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Registrar esta pesta√±a
            const openTabs = JSON.parse(localStorage.getItem('app_open_tabs') || '[]');
            openTabs.push(tabId);
            localStorage.setItem('app_open_tabs', JSON.stringify(openTabs));
            
            // Al cerrar p√°gina, verificar si es la √∫ltima pesta√±a
            window.addEventListener('beforeunload', function() {
                try {
                    const currentTabs = JSON.parse(localStorage.getItem('app_open_tabs') || '[]');
                    const remainingTabs = currentTabs.filter(id => id !== tabId);
                    localStorage.setItem('app_open_tabs', JSON.stringify(remainingTabs));
                    
                    if (remainingTabs.length === 0) {
                        console.log('ÔøΩ √öltima pesta√±a cerrada - Auto-logout ser√° m√°s agresivo');
                        // La l√≥gica de auto-logout ya maneja esto
                    } else {
                        console.log(`üìë ${remainingTabs.length} pesta√±as a√∫n abiertas - Auto-logout suave`);
                    }
                } catch (e) {
                    console.warn('Error gestionando pesta√±as m√∫ltiples:', e);
                }
            });
            
            console.log(`üîê Sistema de auto-logout activado (Pesta√±a: ${tabId})`);
        } catch (e) {
            console.warn('Error configurando gesti√≥n de pesta√±as:', e);
            console.log('üîê Sistema de auto-logout b√°sico activado');
        }
    </script>
</body>
</html>