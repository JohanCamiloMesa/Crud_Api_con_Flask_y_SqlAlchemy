<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANIMES</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" 
    crossorigin="anonymous">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">
    {% include 'Partials/_navegationbar.html' %}

    <div class="mt-4">   
        {% block body %}
        {% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" 
            crossorigin="anonymous"></script>

    <!-- Script para desactivar solo las flechas de navegaciÃ³n del navegador -->
    <script>
        // === CIERRE DE SESIÃ“N AUTOMÃTICO AL CERRAR PÃGINA ===
        let sessionActive = true;
        let isInternalNavigation = false;
        
        // Detectar navegaciÃ³n interna (clics en enlaces del sitio)
        document.addEventListener('click', function(event) {
            const target = event.target.closest('a');
            if (target && target.href) {
                const currentHost = window.location.host;
                const linkHost = new URL(target.href, window.location.href).host;
                
                // Si es un enlace interno, marcar como navegaciÃ³n interna
                if (currentHost === linkHost) {
                    isInternalNavigation = true;
                    console.log('ğŸ”— NavegaciÃ³n interna detectada - No cerrar sesiÃ³n');
                }
            }
            
            // TambiÃ©n detectar clics en botones de submit de formularios
            const button = event.target.closest('button[type="submit"], input[type="submit"]');
            if (button) {
                isInternalNavigation = true;
                console.log('ğŸ“ Submit de formulario detectado - No cerrar sesiÃ³n');
            }
        });
        
        // Detectar envÃ­o de formularios
        document.addEventListener('submit', function(event) {
            isInternalNavigation = true;
            console.log('ğŸ“‹ EnvÃ­o de formulario detectado - No cerrar sesiÃ³n');
        });
        
        // Detectar cuando el usuario cierra la pÃ¡gina/pestaÃ±a (solo si NO es navegaciÃ³n interna)
        window.addEventListener('beforeunload', function(event) {
            // NO cerrar sesiÃ³n si es navegaciÃ³n interna o submit de formulario
            if (isInternalNavigation) {
                console.log('ğŸ“„ NavegaciÃ³n interna - SesiÃ³n se mantiene');
                isInternalNavigation = false;  // Reset para prÃ³xima navegaciÃ³n
                return;
            }
            
            if (sessionActive) {
                console.log('ğŸšª Detectado cierre de pÃ¡gina - Cerrando sesiÃ³n automÃ¡ticamente');
                
                // Usar sendBeacon para envÃ­o confiable al cerrar pÃ¡gina
                const logoutData = new FormData();
                logoutData.append('auto_logout', 'true');
                
                try {
                    // Intentar con sendBeacon (mÃ¡s confiable)
                    const beaconSent = navigator.sendBeacon('/users/auto-logout', logoutData);
                    
                    if (!beaconSent) {
                        // Fallback con fetch sÃ­ncrono si sendBeacon falla
                        fetch('/users/auto-logout', {
                            method: 'POST',
                            body: logoutData,
                            keepalive: true
                        }).catch(error => {
                            console.warn('Error en auto-logout:', error);
                        });
                    }
                    
                    console.log('âœ… Solicitud de cierre de sesiÃ³n enviada');
                } catch (error) {
                    console.error('âŒ Error al enviar auto-logout:', error);
                }
                
                // Limpiar localStorage por seguridad adicional
                try {
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('jwtTokenUserId');
                    localStorage.removeItem('jwtRefreshToken');
                    localStorage.removeItem('jwtTokenExpirationTime');
                    localStorage.removeItem('jwtExpiresIn');
                    localStorage.removeItem('jwtTokenCreatedAt');
                    sessionStorage.clear();
                    console.log('ğŸ§¹ localStorage limpiado por seguridad');
                } catch (e) {
                    console.warn('Error limpiando localStorage:', e);
                }
            } else {
                console.log('ğŸ“„ NavegaciÃ³n interna - No cerrar sesiÃ³n');
            }
        });
        
        // Detectar navegaciÃ³n interna (no cerrar sesiÃ³n en estos casos)
        window.addEventListener('pagehide', function(event) {
            if (event.persisted) {
                console.log('ğŸ“„ PÃ¡gina ocultada pero persistida - No cerrar sesiÃ³n');
                sessionActive = false;
            }
        });
        
        // Desactivar auto-logout en logout manual
        const logoutLinks = document.querySelectorAll('a[href*="logout"]');
        logoutLinks.forEach(link => {
            link.addEventListener('click', function() {
                console.log('ğŸšª Logout manual detectado - Desactivando auto-logout');
                sessionActive = false;
            });
        });
        
        console.log('ğŸ” Sistema de auto-logout mejorado activado - Solo se activa al cerrar pestaÃ±a/ventana');
    </script>
</body>
</html>