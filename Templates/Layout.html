<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANIMES</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" 
    crossorigin="anonymous">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">
    {% include 'Partials/_navegationbar.html' %}

    <div class="mt-4">   
        {% block body %}
        {% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" 
            crossorigin="anonymous"></script>

    <!-- Script para desactivar solo las flechas de navegación del navegador -->
    <script>
        // === BLOQUEO EFECTIVO DE FLECHAS DE NAVEGACIÓN ===
        
        (function() {
            // Configurar inmediatamente al cargar el script
            history.pushState(null, null, location.href);
            
            // Función que se ejecuta cada vez que se intenta navegar hacia atrás
            window.onpopstate = function(event) {
                // Inmediatamente volver a empujar el estado actual
                history.pushState(null, null, location.href);
                
                // Mostrar alerta
                alert('🚫 Navegación hacia atrás desactivada por seguridad.\n\n' +
                      '📍 Usa los enlaces de la aplicación para navegar.');
            };
            
            // Configuración adicional cuando el DOM esté listo
            document.addEventListener('DOMContentLoaded', function() {
                // Asegurar que siempre hay un estado en el historial
                if (window.history.length === 1) {
                    history.pushState(null, null, location.href);
                }
            });
            
            // Método alternativo usando addEventListener
            window.addEventListener('popstate', function(event) {
                // Prevenir el comportamiento predeterminado
                event.preventDefault();
                
                // Forzar a quedarse en la página actual
                history.pushState(null, null, location.href);
                
                console.log('🚫 Intento de navegación hacia atrás bloqueado');
            }, false);
            
            // Bloquear atajos de teclado para navegación
            document.addEventListener('keydown', function(event) {
                // Alt + Flecha Izquierda (Atrás)
                if (event.altKey && event.keyCode === 37) {
                    event.preventDefault();
                    event.stopPropagation();
                    alert('🚫 Atajo Alt + ← desactivado');
                    return false;
                }
                
                // Alt + Flecha Derecha (Adelante)  
                if (event.altKey && event.keyCode === 39) {
                    event.preventDefault();
                    event.stopPropagation();
                    alert('🚫 Atajo Alt + → desactivado');
                    return false;
                }
                
                // Backspace para navegación (no en inputs)
                if (event.keyCode === 8 && 
                    !event.target.matches('input, textarea, [contenteditable="true"]')) {
                    event.preventDefault();
                    event.stopPropagation();
                    alert('🚫 Navegación con Backspace desactivada');
                    return false;
                }
            }, true);
            
            // Mantener el bloqueo activo de forma continua
            setInterval(function() {
                if (history.length === 1) {
                    history.pushState(null, null, location.href);
                }
            }, 1000);
            
        })();
    </script>

    <!-- Script para cerrar sesión automáticamente SOLO al cerrar la pestaña/ventana -->
    <script>
        // === CIERRE DE SESIÓN AUTOMÁTICO SOLO AL CERRAR PESTAÑA/VENTANA ===
        let sessionActive = true;
        let isNavigating = false;
        
        // Detectar navegación interna (enlaces, formularios, etc.)
        document.addEventListener('click', function(event) {
            const target = event.target.closest('a, button, input[type="submit"]');
            if (target && !target.href?.includes('logout')) {
                console.log('🔗 Navegación interna detectada - Desactivando auto-logout temporalmente');
                isNavigating = true;
                sessionActive = false;
                
                // Reactivar auto-logout después de un breve delay
                setTimeout(() => {
                    isNavigating = false;
                    sessionActive = true;
                    console.log('✅ Auto-logout reactivado después de navegación');
                }, 1000);
            }
        });
        
        // Detectar cuando el usuario cierra la página/pestaña REALMENTE
        window.addEventListener('beforeunload', function(event) {
            // Solo cerrar sesión si NO es navegación interna
            if (sessionActive && !isNavigating) {
                console.log('🚪 Cierre real de pestaña/ventana detectado - Cerrando sesión automáticamente');
                
                // Usar sendBeacon para envío confiable al cerrar página
                const logoutData = new FormData();
                logoutData.append('auto_logout', 'true');
                
                try {
                    // Intentar con sendBeacon (más confiable)
                    const beaconSent = navigator.sendBeacon('/users/auto-logout', logoutData);
                    
                    if (!beaconSent) {
                        // Fallback con fetch síncrono si sendBeacon falla
                        fetch('/users/auto-logout', {
                            method: 'POST',
                            body: logoutData,
                            keepalive: true
                        }).catch(error => {
                            console.warn('Error en auto-logout:', error);
                        });
                    }
                    
                    console.log('✅ Solicitud de cierre de sesión enviada');
                } catch (error) {
                    console.error('❌ Error al enviar auto-logout:', error);
                }
                
                // Limpiar localStorage por seguridad adicional
                try {
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('jwtTokenUserId');
                    localStorage.removeItem('jwtRefreshToken');
                    localStorage.removeItem('jwtTokenExpirationTime');
                    localStorage.removeItem('jwtExpiresIn');
                    localStorage.removeItem('jwtTokenCreatedAt');
                    sessionStorage.clear();
                    console.log('🧹 localStorage limpiado por seguridad');
                } catch (e) {
                    console.warn('Error limpiando localStorage:', e);
                }
            } else {
                console.log('📄 Navegación interna - No cerrar sesión');
            }
        });
        
        // Detectar navegación interna (no cerrar sesión en estos casos)
        window.addEventListener('pagehide', function(event) {
            if (event.persisted) {
                console.log('📄 Página ocultada pero persistida - No cerrar sesión');
                sessionActive = false;
            }
        });
        
        // Desactivar auto-logout en logout manual
        const logoutLinks = document.querySelectorAll('a[href*="logout"]');
        logoutLinks.forEach(link => {
            link.addEventListener('click', function() {
                console.log('🚪 Logout manual detectado - Desactivando auto-logout');
                sessionActive = false;
            });
        });
        
        console.log('🔐 Sistema de auto-logout mejorado activado - Solo se activa al cerrar pestaña/ventana');
    </script>
</body>
</html>